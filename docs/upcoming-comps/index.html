<!DOCTYPE html>
<html>
  <head>
    <title>Upcoming comps - RaspBella</title>
    <link rel="stylesheet" href="/main.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">
  </head>
  <body>
    <div>
      <label for="input-wca-id">Input WCA ID:</label>
      <input id="input-wca-id"/>
      <button id="submit-wca-id">Submit</button>

      <h3 id="user-not-found" style="color: red; display: none;">User not found</h3>

      <div id="person" style="display: none;">
        <h3 id="name">Name:</h3>
        <h3 id="region">Region:</h3>
        <h3 id="wca-id">WCA ID:</h3>
      </div>
    </div>
  </body>
  <script>
    function is_digit(c) {
      return c >= '0' && c <= '9';
    }

    function is_upper(c) {
      return c >= 'A' && c <= 'Z';
    }

    function is_lower(c) {
      return c >= 'a' && c <= 'z';
    }

    function is_alpha(c) {
      return is_upper(c) || is_lower(c);
    }

    function valid_wca_id(str) {
      if (str.length != 10) return false;

      if (!is_digit(str[0])) return false;
      if (!is_digit(str[1])) return false;
      if (!is_digit(str[2])) return false;
      if (!is_digit(str[3])) return false;

      if (!is_alpha(str[4])) return false;
      if (!is_alpha(str[5])) return false;
      if (!is_alpha(str[6])) return false;
      if (!is_alpha(str[7])) return false;

      if (!is_digit(str[8])) return false;
      if (!is_digit(str[9])) return false;

      return true;
    }

    const default_wca_id = "2018CAMP17";

    document.getElementById("submit-wca-id").onclick = () => {
      const input_wca_id = document.getElementById("input-wca-id").value;

      if (valid_wca_id(input_wca_id)) {
        location.search = `?${input_wca_id}`;
      }
    };

    const wca_id = location.search.slice(1);

    if (!valid_wca_id(wca_id)) {
      location.search = `?${default_wca_id}`;
    }

    const url = `https://www.worldcubeassociation.org/api/v0/users/${wca_id}?upcoming_competitions=true`;
  
    fetch(url)
      .then(txt => txt.json())
      .then(data => {
        if (!data.user) {
          document.getElementById("user-not-found").style.display = "block";
        }

        else {
          const person = document.getElementById("person");

          document.getElementById("name").innerText = `Name: ${data.user.name}`;
          document.getElementById("region").innerText = `Region: ${data.user.country.name}`;
          document.getElementById("wca-id").innerText = `WCA ID: ${data.user.wca_id}`;
  
          const comps = data.upcoming_competitions.sort(
            (a, b) => {
              return a.start_date > b.start_date ? 1 : b.start_date > a.start_date ? -1 : 0;
            }
          );
    
          if (comps.length > 0) {
            const comps_table = document.createElement("table");

            comps_table.innerHTML = "<thead><tr><th>#</th><th>Date range</th><th>Name</th></tr></thead>";

            const table_body = document.createElement("tbody");

            for (let i = 0; i < comps.length; ++i) {
              const row = table_body.insertRow();

              row.innerHTML = `<td>${i+1}</td><td>${comps[i].date_range}</td><td><a href="${comps[i].url}">${comps[i].name}</a></td>`;
            }

            person.appendChild(comps_table.appendChild(table_body));
          }
    
          else {
            person.appendChild(document.createTextNode("No upcoming comps"));
          }
  
          person.style.display = "block";
        }
      })
      .catch(error => console.error("Error retrieving data"));
  </script>
</html>
